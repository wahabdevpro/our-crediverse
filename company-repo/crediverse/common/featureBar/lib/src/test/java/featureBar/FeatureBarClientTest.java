/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package featureBar;

import io.etcd.jetcd.ByteSequence;
import io.etcd.jetcd.Client;
import io.etcd.jetcd.KV;

import java.io.File;

import io.grpc.netty.GrpcSslContexts;
import io.netty.handler.ssl.SslContext;

import java.lang.Thread;

import org.junit.jupiter.api.BeforeAll;
import org.junit.jupiter.api.Disabled;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.Timeout;

import static org.junit.jupiter.api.Assertions.assertFalse;
import static org.junit.jupiter.api.Assertions.assertTrue;
import static org.junit.jupiter.api.Assertions.fail;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

@Disabled("Class can't be tested in CI/CD")
@Timeout(value = 30)

public class FeatureBarClientTest {
	private static final Logger logger = LoggerFactory.getLogger(FeatureBarClient.class);

	private static class TestingClient  {
		public static void toggleFeatureYes(String featureId,
				String certificateAuthorityCertificateFilename,
				String certificateFilename,
				String privateKeyFilename   )  
			// This is to test a negative case. Features MUST be true and false, NOT yes.
		{
			System.out.println(String.format("\n\ntoggling %s\n\n",featureId));
			try {
				File caCert =new File( certificateAuthorityCertificateFilename );

				File keyCertChainFile = new File( certificateFilename );
				File keyFile = new File(privateKeyFilename);

				SslContext context = GrpcSslContexts.forClient()
					.trustManager(caCert)
					.keyManager(keyCertChainFile, keyFile)
					.build();

				Client client = Client
					.builder()
					.endpoints("https://localhost:2379")
					.sslContext(context)
					.build();

				KV kvClient = client.getKVClient();
				ByteSequence key = ByteSequence.from(featureId.getBytes());
				ByteSequence value = ByteSequence.from("yes".getBytes());
				kvClient.put(key, value).get();

			} catch (Exception e) {
				e.printStackTrace();
				System.out.println(e.toString());
			}
		}

		public static void toggleFeature(String featureId, boolean state,
				String certificateAuthorityCertificateFilename,
				String certificateFilename,
				String privateKeyFilename   )  
		{
			System.out.println(String.format("\n\ntoggling %s\n\n",featureId));
			try {
				File caCert =new File( certificateAuthorityCertificateFilename );

				File keyCertChainFile = new File( certificateFilename );
				File keyFile = new File(privateKeyFilename);

				SslContext context = GrpcSslContexts.forClient()
					.trustManager(caCert)
					.keyManager(keyCertChainFile, keyFile)
					.build();

				Client client = Client
					.builder()
					.endpoints("https://localhost:2379")
					.sslContext(context)
					.build();



				KV kvClient = client.getKVClient();
				ByteSequence key = ByteSequence.from(featureId.getBytes());
				ByteSequence value = ByteSequence.from((state?"true":"false").getBytes());

				kvClient.put(key, value).get();

			} catch (Exception e) {
				e.printStackTrace();
				System.out.println(e.toString());
			}
		}

	};

	private static String caCert = "../tls/concurrent_ca.crt";
	private static String clientCert = "../tls/client.crt";
	private static String clientKey = "../tls/client.key.pem";

	@BeforeAll
	public static void init() {
		System.out.println("\n\nInititalizing Tests\n\n");

		TestingClient.toggleFeature("crediverse.show_the_app_cached", true,caCert ,clientCert,clientKey);
		TestingClient.toggleFeature("crediverse.show_the_app", true,caCert ,clientCert,clientKey);
		TestingClient.toggleFeature("crediverse.do_not_show_the_app", false,caCert ,clientCert,clientKey);
		TestingClient.toggleFeatureYes("crediverse.yes_is_not_true",caCert ,clientCert,clientKey);

		System.out.println("\n\nInititalizing DONE! \n\n");
	}

	@Test public void featureCachingGetsUpdatedByWatcher() 
	{
		try (FeatureBarClient featureBar = new FeatureBarClient( "https://localhost:2379" ,clientKey,clientCert,caCert)) {

			TestingClient.toggleFeature("crediverse.show_the_app_cached", true,caCert ,clientCert,clientKey);

			assertTrue(
					featureBar.isFeatureAvailable("crediverse.show_the_app_cached"), 
					"isFeatureAvailable should return 'true' when the value has been set to true");

			TestingClient.toggleFeature("crediverse.show_the_app_cached", false,caCert ,clientCert,clientKey);


			Thread.sleep(50);

			assertFalse(
					featureBar.isFeatureAvailable("crediverse.show_the_app_cached"), 
					"isFeatureAvailable should return 'false' when the value has been set false");

		}  catch (Exception e ) {
			logger.error("unexpected exception: {}",e);
			fail("unexpected exception");
		} 
	} 
	@Test public void isFeatureAvailableMethodReturnsFalseForUnknownFeatures() 
	{
		try (FeatureBarClient featureBar = new FeatureBarClient("https://127.0.0.1:2379",clientKey,clientCert,caCert)) 
		{
			assertFalse(
					featureBar.isFeatureAvailable("crediverse.paint_the_plannet"),
					"isFeatureAvailable should return 'false' when the feature has not been registered with the FeatureBar");
		}
		catch (Exception e ) {
			logger.error("unexpected exception: {}",e);
			fail("unexpected exception");
		} 
	}

	@Test public void isFeatureAvailableMethodReturnsTrueForKownSwitchedOnFeatures() 
	{
		try(FeatureBarClient featureBar = new FeatureBarClient("https://127.0.0.1:2379",clientKey,clientCert,caCert))
		{
			assertTrue(
					featureBar.isFeatureAvailable("crediverse.show_the_app"),
					"isFeatureAvailable should return 'true' when the feature has been registered with the FeatureBar and set to true");
		}
		catch (Exception e ) {
			logger.error("unexpected exception: {}",e);
			fail("unexpected exception");
		} 
	}

	@Test public void isFeatureAvailableMethodReturnsFalseForKownSwitchedOffFeatures() 
	{
		try (FeatureBarClient featureBar = new FeatureBarClient("https://127.0.0.1:2379",clientKey,clientCert,caCert)) 
		{
			assertFalse( 
					featureBar.isFeatureAvailable("crediverse.do_not_show_the_app"),
					"isFeatureAvailable should return 'false' when the feature has been registered and set to false");

		}
		catch (Exception e ) {
			logger.error("unexpected exception: {}",e);
			fail("unexpected exception");
		} 
	}

	@Test public void isFeatureAvailableMethodReturnsFalseForKownCorruptedFeatures() 
	{
		try (FeatureBarClient featureBar = new FeatureBarClient("https://127.0.0.1:2379",clientKey,clientCert,caCert)) 
		{
			assertFalse(
					featureBar.isFeatureAvailable("crediverse.yes_is_not_true"),
					"isFeatureAvailable should return 'false' when the feature has been registered and set to false");
		}
		catch (Exception e ) {
			logger.error("unexpected exception: {}",e);
			fail("unexpected exception");
		} 
	}

	@Test public void isFeatureAvailableMethodReturnsFalseIfServerIsNotAvailable() 
	{
		try (FeatureBarClient featureBar = new FeatureBarClient("https://nottoday:10000",clientKey,clientCert,caCert)) 
		{
			assertFalse(
					featureBar.isFeatureAvailable("crediverse.show_the_app_on_not_existing_server"),
					"isFeatureAvailable should return 'false' when the feature bar server is not availabe");
		}
		catch (Exception e ) {
			logger.error("unexpected exception: {}",e);
			fail("unexpected exception");
		} 
	}
}
