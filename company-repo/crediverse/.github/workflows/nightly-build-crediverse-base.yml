name: Nightly Build Crediverse Base workflow

# Controls when the workflow will run
on:
  workflow_call:
    inputs:
      BRANCH_NAME:
        required: false
        type: string
        default: 'main'
      GITHUB_TAGNAME:
        required: false
        type: string
        default: 'nightly_build'
      DOCKER_TAGNAME:
        required: false
        type: string
        default: 'nightly_build_${{github.run_id}}'
    secrets:
      DB_PASS:
        required: true
concurrency:
  group: nightly_build
env:
  TS_IMAGE_NAME: ecds-ts
  API_IMAGE_NAME: ecds-api
  GUI_IMAGE_NAME: ecds-gui
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
jobs:
  check-repo-status:
    name: check-repo-status
    runs-on: ubuntu-latest
    steps:
      - name: 'Job Start Time'
        run: |
          CS_START_TIME=$(date +"%Y-%m-%dT%H:%M:%S")
          echo "Start Time => $CS_START_TIME"
          echo "NOW=$(date +%Y-%m-%d -d "yesterday")" >> $GITHUB_ENV
          echo ${{inputs.BRANCH_NAME}}
      - name: downcase REPO
        run: |
          echo "REPO_LOWERCASE=${GITHUB_REPOSITORY,,}" >>${GITHUB_ENV}
      - uses: 'actions/checkout@v3'
        with:
          ref: ${{inputs.BRANCH_NAME}}
      - uses: tj-actions/branch-names@v6
      - name: Check for new commits today
        id: check-new-commits
        uses: adriangl/check-new-commits-action@v1
        with:
          token: ${{secrets.GITHUB_TOKEN}}
          seconds: 86400 # One day in seconds
          branch: ${{inputs.BRANCH_NAME}}
      - name: get repository name
        run: echo "REPOSITORY_NAME=${GITHUB_REPOSITORY#*/}" >> $GITHUB_ENV
      - name: convert Repo name
        run: echo "REPO_LC=${REPO_LOWERCASE#*/}" >> $GITHUB_ENV
      - name: Read version.txt
        run: |-
          VER=$(cat ${{github.workspace}}/version.txt)
          echo "BuildVersion=$VER" >> $GITHUB_ENV
      - name: Generate Changelog for main
        if: inputs.BRANCH_NAME == 'main'
        run: |-
          rm -f ${{ github.workspace }}/Crediverse-${{inputs.BRANCH_NAME}}-CHANGELOG.md
          echo "Crediverse-${{inputs.BRANCH_NAME}} " > ${{ github.workspace }}/Crediverse-${{inputs.BRANCH_NAME}}-CHANGELOG.md
          echo "Release Date | ${{env.NOW}}" >> ${{ github.workspace }}/Crediverse-${{inputs.BRANCH_NAME}}-CHANGELOG.md
          echo "Build Number | ${{ github.run_id }}" >> ${{ github.workspace }}/Crediverse-${{inputs.BRANCH_NAME}}-CHANGELOG.md

      - name: Generate Changelog file
        if: inputs.BRANCH_NAME != 'main'
        run: |-
          rm -f ${{ github.workspace }}-${{inputs.BRANCH_NAME}}-CHANGELOG.md
          echo "Crediverse-${{env.BuildVersion}} " > ${{ github.workspace }}/Crediverse-${{inputs.BRANCH_NAME}}-CHANGELOG.md
          echo "Release Date | ${{env.NOW}}" >> ${{ github.workspace }}/Crediverse-${{inputs.BRANCH_NAME}}-CHANGELOG.md
          echo "Build Number | ${{ github.run_id }}" >> ${{ github.workspace }}/Crediverse-${{inputs.BRANCH_NAME}}-CHANGELOG.md
      - name: check release notes file
        if: inputs.BRANCH_NAME != 'main'
        run: >-
          if [[ -f "${{github.workspace}}/release_notes/${{env.REPO_LC}}_release_notes_${{ env.BuildVersion }}.md" ]]; 
          then 
              cat "${{github.workspace}}/release_notes/${{env.REPO_LC}}_release_notes_${{ env.BuildVersion }}.md" >> ${{ github.workspace }}-${{inputs.BRANCH_NAME}}-CHANGELOG.md
          fi
      - name: Check Advisory Notes file
        if: inputs.BRANCH_NAME != 'main'
        run: >-
          if [[ -f "${{github.workspace}}/release_notes/${{env.REPO_LC}}_advisory_notes_${{ env.BuildVersion }}.md" ]]; 
          then
            echo "## Internal" >> ${{ github.workspace }}/Crediverse-${{inputs.BRANCH_NAME}}-CHANGELOG.md
            echo "[Advisory Note](${{github.server_url}}/${{github.repository}}/tree/${{env.BRANCH_NAME}}/release_notes/${{env.REPO_LC}}_advisory_notes_${{ env.BuildVersion }}.md) " >> ${{ github.workspace }}/Crediverse-${{inputs.BRANCH_NAME}}-CHANGELOG.md
          fi
      - name: edit changelog
        run: |-
          echo "## DOCKER IMAGES" >> ${{ github.workspace }}/Crediverse-${{inputs.BRANCH_NAME}}-CHANGELOG.md
          cat ${{ github.workspace }}/Crediverse-${{inputs.BRANCH_NAME}}-CHANGELOG.md
      - name: New Commits found for today
        id: check_true_condition
        if: ${{ steps.check-new-commits.outputs.has-new-commits == 'true' }}
        run: |-
          echo "run_job=yes" >> $GITHUB_OUTPUT
      - name: New Commits Not found
        id: check_false_condition
        if: ${{ steps.check-new-commits.outputs.has-new-commits != 'true' }}
        run: |-
          echo "run_job=no" >> $GITHUB_OUTPUT
      - name: Upload Changelog
        uses: actions/upload-artifact@v4
        with:
          name: changelog-${{ inputs.BRANCH_NAME }}-${{github.run_id}}  
          path: ${{ github.workspace }}/Crediverse-${{ inputs.BRANCH_NAME }}-CHANGELOG.md
          overwrite: true
      - name: check outptut
        run: |-
          ls -ltrh ${{github.workspace}}
          cat ${{ github.workspace }}/Crediverse-${{inputs.BRANCH_NAME}}-CHANGELOG.md
              
    outputs:
      run_job: ${{ steps.check_true_condition.outputs.run_job }}
      run_job1: ${{ steps.check_false_condition.outputs.run_job }}

  build-and-publish-featurebar:
    needs:
      - check-repo-status
    if: false
    #if: needs.check-repo-status.outputs.run_job =='yes' || needs.check-repo-status.outputs.run_job1 =='yes'
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
      packages: 'write'
    steps:
      - name: 'Feature Bar Start Time'
        run: |
          CS_FEATURE_BAR_START_TIME=$(date +"%Y-%m-%dT%H:%M:%S")
          echo "Feature Bar Build Starts at => $CS_FEATURE_BAR_START_TIME"
      - uses: 'actions/checkout@v3'
        with:
          ref: ${{inputs.BRANCH_NAME}}
      - name: Login to ghcr
        run: |-
          echo ${{ github.repository }}
          echo ${{ github.run_id }}
          echo ${{ github.run_number }}
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u $ --password-stdin
      - name: Download Changelog
        uses: actions/download-artifact@v4
        with:
            name: changelog-${{inputs.BRANCH_NAME}}-${{github.run_id}}  
      - name: check output
        run: | 
            ls -ltrh ${{github.workspace}}
            cat ${{ github.workspace }}/Crediverse-${{inputs.BRANCH_NAME}}-CHANGELOG.md
      - name: Configure Version Information
        id: version-info
        run: |-
          IMAGE_ID=ghcr.io/${{ github.repository }}/feature-bar
          IMAGE_ID=$(echo $IMAGE_ID | tr '[A-Z]' '[a-z]')
          VERSION=${{inputs.DOCKER_TAGNAME}}
          echo IMAGE_ID=$IMAGE_ID
          echo VERSION=$VERSION
          echo GCR_PROJECT_ID=$GCR_PROJECT_ID
          # Share variables between steps (which each run in a separate process)
          echo "IMAGE_ID=$IMAGE_ID" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV
      - name: Build Image
        run: |-
          IMAGE_NAME=feature-bar
          echo "Building $IMAGE_NAME"
          cd common/featureBar/server/featureBarImage

          docker build -t ${{ env.IMAGE_ID }}:${{ env.VERSION }} .
          echo "- [${{env.IMAGE_ID}}:${{inputs.DOCKER_TAGNAME}}](https://${{env.IMAGE_ID}}:${{inputs.DOCKER_TAGNAME}})" >> ${{ github.workspace }}-${{inputs.BRANCH_NAME}}-CHANGELOG.md
          docker tag ${{ env.IMAGE_ID }}:${{ env.VERSION }} ${{ env.IMAGE_ID }}:latest
          docker push ${{ env.IMAGE_ID }}:${{ env.VERSION }}
          docker push ${{ env.IMAGE_ID }}:latest
      - name: Upload Changelog
        uses: actions/upload-artifact@v4
        with:
         name: changelog-${{ inputs.BRANCH_NAME }}-${{github.run_id}}  
         path: ${{ github.workspace }}/Crediverse-${{ inputs.BRANCH_NAME }}-CHANGELOG.md
         overwrite: true
        
      - name: check outptut
        run: |-
            ls -ltrh ${{github.workspace}}
            cat ${{ github.workspace }}/Crediverse-${{inputs.BRANCH_NAME}}-CHANGELOG.md
  build-crediverse:
    needs:
      - check-repo-status
    if: needs.check-repo-status.outputs.run_job =='yes' || needs.check-repo-status.outputs.run_job1 =='yes'
    strategy:
      max-parallel: 1

      matrix:
        #IMAGE_NAME: [$API_IMAGE_NAME]
        IMAGE_NAME: [$TS_IMAGE_NAME, $API_IMAGE_NAME, $GUI_IMAGE_NAME]
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    permissions:
      contents: 'read'
      id-token: 'write'
      packages: 'write'

    steps:
      - name: 'Job Start Time'
        run: |
          CS_START_TIME=$(date +"%Y-%m-%dT%H:%M:%S")
          echo "Start Time => $CS_START_TIME"
      - uses: 'actions/checkout@v3'
        with:
          ref: ${{inputs.BRANCH_NAME}}
      - name: Set up JDK 11 for x64
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'adopt'
          architecture: x64
      #- name: Validate Gradle wrapper
      #  # See https://github.com/gradle/wrapper-validation-action
      #  uses: gradle/wrapper-validation-action@v1.0.4
      #- name: Run the Gradle package task
      #  # See https://github.com/gradle/gradle-build-action
      #  uses: gradle/gradle-build-action@v2
      #  with:
      #    gradle-version: wrapper
      #    arguments: build -x test -x check
      - name: Print java version
        run: |-
          which java
          java --version
      - name: Login to ghcr
        run: |-
          echo ${{ github.repository }}
          echo ${{ github.run_id }}
          echo ${{ github.run_number }}
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u $ --password-stdin
          #echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
      - name: Download Changelog
        uses: actions/download-artifact@v4
        with:
              name: changelog-${{inputs.BRANCH_NAME}}-${{github.run_id}}  
      - name: check output
        run: | 
              ls -ltrh ${{github.workspace}}
              cat ${{ github.workspace }}/Crediverse-${{inputs.BRANCH_NAME}}-CHANGELOG.md
      - name: Configure Version Information
        id: version-info
        run: |-
          IMAGE_ID=ghcr.io/${{ github.repository }}/${{ matrix.IMAGE_NAME }}
          IMAGE_ID=$(echo $IMAGE_ID | tr '[A-Z]' '[a-z]')
          VERSION=${{inputs.DOCKER_TAGNAME}}
          echo IMAGE_ID=$IMAGE_ID
          echo VERSION=$VERSION
          echo GCR_PROJECT_ID=$GCR_PROJECT_ID
          # Share variables between steps (which each run in a separate process)
          echo "IMAGE_ID=$IMAGE_ID" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV
      - name: Build Image
        run: |-
          IMAGE_NAME=${{ matrix.IMAGE_NAME }}
          export CI_BUILD_DATETIME=$(date +"%Y-%m-%dT%H:%M:%S")
          export CI_BUILD_NUMBER=${{github.run_id}}
          export CI_COMMIT_REF=${{github.sha}}
          export CI_GITHUB_TAG=${{inputs.GITHUB_TAGNAME}}
          export CI_BRANCH_NAME=${{inputs.BRANCH_NAME}}
          export CI_DOCKER_TAG=${{inputs.DOCKER_TAGNAME}}
          echo $CI_BUILD_DATETIME
          echo $CI_BUILD_NUMBER
          echo $CI_COMMIT_REF
          echo $CI_GITHUB_TAG
          echo $CI_BRANCH_NAME
          echo $CI_DOCKER_TAG

          echo "Building $IMAGE_NAME"
          cd ./$IMAGE_NAME
          ./gradlew --info --stacktrace clean
          ./gradlew --info --stacktrace publish
          docker build -t ${{ env.IMAGE_ID }}:${{ env.VERSION }} .
          echo "- [${{env.IMAGE_ID}}:${{inputs.DOCKER_TAGNAME}}](https://${{env.IMAGE_ID}}:${{inputs.DOCKER_TAGNAME}})" >> ${{ github.workspace }}/Crediverse-${{inputs.BRANCH_NAME}}-CHANGELOG.md
          docker tag ${{ env.IMAGE_ID }}:${{ env.VERSION }} ${{ env.IMAGE_ID }}:latest
          docker push ${{ env.IMAGE_ID }}:${{ env.VERSION }}
          docker push ${{ env.IMAGE_ID }}:latest
      - name: Upload Changelog
        uses: actions/upload-artifact@v4
        with:
           name: changelog-${{ inputs.BRANCH_NAME }}-${{github.run_id}}    
           path: ${{ github.workspace }}/Crediverse-${{ inputs.BRANCH_NAME }}-CHANGELOG.md
           overwrite: true
      
      - name: check outptut
        run: |-
              ls -ltrh ${{github.workspace}}
              cat ${{ github.workspace }}/Crediverse-${{inputs.BRANCH_NAME}}-CHANGELOG.md
  build-crediverse-mobile:
    runs-on: ubuntu-latest
    needs:
      - check-repo-status
      - build-crediverse
    if: needs.check-repo-status.outputs.run_job =='yes' || needs.check-repo-status.outputs.run_job1 =='yes'
    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{inputs.BRANCH_NAME}}
      - name: Set up JDK 17 for Android SDK
        uses: actions/setup-java@v3
        with:
            java-version: 17
            distribution: 'adopt'
      - name: Setup Android SDK
        uses: android-actions/setup-android@v2
      - name: Set up JDK 11 for MobileApp
        uses: actions/setup-java@v3
        with:
            java-version: 11
            distribution: 'adopt'  
      - name: Run Gradle Tests
        run: |
          cd CrediverseMobile && time ./gradlew --no-daemon test && cd ../
      - name: Assemble all APKs
        run: |
          export BUILD_NUMBER=${{ github.run_id }}
          cd CrediverseMobile && time ./gradlew --no-daemon assemble && cd ../
      - name: App Artifacts (CS)
        uses: actions/upload-artifact@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          name: Concurrent APKs
          path: |
            CrediverseMobile/app/build/outputs/apk/debug_demo_server/*.apk
            CrediverseMobile/app/build/outputs/apk/sandbox/*.apk
            #### We don't use a release file just yet
            # CrediverseMobile/app/build/outputs/apk/release/*.apk
          retention-days: 5
          overwrite: true
      - name: App Artifacts (MovIvy)
        uses: actions/upload-artifact@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          name: Moov Ivory Coast APKs
          path: CrediverseMobile/app/build/outputs/apk/movivy*/*.apk
          retention-days: 5
          overwrite: true
      - name: App Artifact (MovTog)
        uses: actions/upload-artifact@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          name: Moov Togo APK
          path: CrediverseMobile/app/build/outputs/apk/movtog*/*.apk
          retention-days: 5
          overwrite: true
  build-mas:
    runs-on: ubuntu-latest
    needs:
      - check-repo-status
      - build-crediverse
      - build-crediverse-mobile
    if: needs.check-repo-status.outputs.run_job =='yes' || needs.check-repo-status.outputs.run_job1 =='yes'
    steps:
      - name: Install packages for MAS build
        run: sudo apt update -y && sudo apt -y install openssl libssl-dev pkg-config  protobuf-compiler
      - uses: actions/checkout@v3
        with:
          ref: ${{inputs.BRANCH_NAME}}
      - name: Install cargo latest nightly
        uses: actions-rs/toolchain@v1
        with:
          toolchain: 1.83.0
          override: true
          components: rustfmt, clippy

      # `cargo check` command here will use installed `nightly`
      # as it is set as an "override" for current directory

      - name: 'Mobile Application Service build Start Time'
        run: |
          CS_MAS_START_TIME=$(date +"%Y-%m-%dT%H:%M:%S")
          echo "Mobile Application Server Build Starts at => $CS_MAS_START_TIME"
      - uses: 'actions/checkout@v3'
        with:
          ref: ${{inputs.BRANCH_NAME}}
      - name: Login to ghcr for publishing MAS image
        run: |-
          echo ${{ github.repository }}
          echo ${{ github.run_id }}
          echo ${{ github.run_number }}
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u $ --password-stdin
      - name: Download Changelog
        uses: actions/download-artifact@v4
        with:
          name: changelog-${{inputs.BRANCH_NAME}}-${{github.run_id}}  
      - name: check output
        run: | 
              ls -ltrh ${{github.workspace}}
              cat ${{ github.workspace }}/Crediverse-${{inputs.BRANCH_NAME}}-CHANGELOG.md
      - name: Configure MAS Version Information
        id: version-info
        run: |-
          IMAGE_ID=ghcr.io/${{ github.repository }}/MobileApplicationService
          IMAGE_ID=$(echo $IMAGE_ID | tr '[A-Z]' '[a-z]')
          VERSION=${{inputs.DOCKER_TAGNAME}}
          echo IMAGE_ID=$IMAGE_ID
          echo VERSION=$VERSION
          echo GCR_PROJECT_ID=$GCR_PROJECT_ID
          # Share variables between steps (which each run in a separate process)
          echo "IMAGE_ID=$IMAGE_ID" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV
      - name: Build MAS Image
        run: |-
          IMAGE_NAME=mobile_application_service
          echo "Building $IMAGE_NAME"
          cd ${{github.workspace}}/MobileApplicationService
          export CI_BUILD_DATETIME=$(date +"%Y-%m-%dT%H:%M:%S")
          export CI_BUILD_NUMBER=${{github.run_id}}
          export CI_COMMIT_REF=${{github.sha}}
          export CI_GITHUB_TAG=${{inputs.GITHUB_TAGNAME}}
          export CI_BRANCH_NAME=${{inputs.BRANCH_NAME}}
          export CI_DOCKER_TAG=${{inputs.DOCKER_TAGNAME}}
          echo $CI_BUILD_DATETIME
          echo $CI_BUILD_NUMBER
          echo $CI_COMMIT_REF
          echo $CI_GITHUB_TAG
          echo $CI_BRANCH_NAME
          echo $CI_DOCKER_TAG
          docker build --build-arg CI_BUILD_DATETIME=$CI_BUILD_DATETIME --build-arg CI_BUILD_NUMBER=$CI_BUILD_NUMBER --build-arg CI_COMMIT_REF=$CI_COMMIT_REF --build-arg CI_GITHUB_TAG=$CI_GITHUB_TAG --build-arg CI_BRANCH_NAME=$CI_BRANCH_NAME --build-arg CI_DOCKER_TAG=$CI_DOCKER_TAG -f ${{github.workspace}}/MobileApplicationService/dockerfile.prod -t ${{ env.IMAGE_ID }}:${{ env.VERSION }} .
          docker tag ${{ env.IMAGE_ID }}:${{ env.VERSION }} ${{ env.IMAGE_ID }}:latest
          docker push ${{ env.IMAGE_ID }}:${{ env.VERSION }}
          echo "- [${{env.IMAGE_ID}}:${{env.VERSION}}](https://${{env.IMAGE_ID}}:${{env.VERSION}})" >> ${{ github.workspace }}/Crediverse-${{inputs.BRANCH_NAME}}-CHANGELOG.md
          docker push ${{ env.IMAGE_ID }}:latest
      - name: Upload Changelog
        uses: actions/upload-artifact@v4
        with:
         name: changelog-${{ inputs.BRANCH_NAME }}-${{github.run_id}}     
         path: ${{ github.workspace }}/Crediverse-${{ inputs.BRANCH_NAME }}-CHANGELOG.md
         overwrite: true
     
      - name: check outptut
        run: |-
          ls -ltrh ${{github.workspace}}
          cat ${{ github.workspace }}/Crediverse-${{inputs.BRANCH_NAME}}-CHANGELOG.md          
  build-teamService:
    runs-on: ubuntu-latest
    needs:
      - check-repo-status
      - build-crediverse
      - build-crediverse-mobile
      - build-mas
    if: needs.check-repo-status.outputs.run_job =='yes' || needs.check-repo-status.outputs.run_job1 =='yes'
    steps:
      - name: Install packages for TeamService build
        run: sudo apt update -y && sudo apt -y install openssl libssl-dev pkg-config runit
      - uses: actions/checkout@v3
        with:
          ref: ${{inputs.BRANCH_NAME}}
      - name: Install cargo latest nightly
        uses: actions-rs/toolchain@v1
        with:
          toolchain: 1.83.0
          override: true
          components: rustfmt, clippy

      # `cargo check` command here will use installed `nightly`
      # as it is set as an "override" for current directory

      - name: 'Team Service build Start Time'
        run: |
          CS_TEAM_SERVICE_START_TIME=$(date +"%Y-%m-%dT%H:%M:%S")
          echo "Team Service Build Starts at => $CS_TEAM_SERVICE_START_TIME"
      - uses: 'actions/checkout@v3'
        with:
          ref: ${{inputs.BRANCH_NAME}}
      - name: Login to ghcr for publishing MAS image
        run: |-
          echo ${{ github.repository }}
          echo ${{ github.run_id }}
          echo ${{ github.run_number }}
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u $ --password-stdin
      - name: Download Changelog
        uses: actions/download-artifact@v4
        with:
          name: changelog-${{inputs.BRANCH_NAME}}-${{github.run_id}}  
      - name: check output
        run: | 
              ls -ltrh ${{github.workspace}}
              cat ${{ github.workspace }}/Crediverse-${{inputs.BRANCH_NAME}}-CHANGELOG.md
      - name: Configure Team Service Version Information
        id: version-info
        run: |-
          IMAGE_ID=ghcr.io/${{ github.repository }}/TeamService
          IMAGE_ID=$(echo $IMAGE_ID | tr '[A-Z]' '[a-z]')
          #VERSION=$(echo "${{ github.ref }}" | sed -e 's,.*/\(.*\),\1,')
          #[ "$VERSION" == "main" ] && VERSION=build-${{github.run_number}}
          #VERSION=$VERSION-build-${{github.run_number}}
          VERSION=${{inputs.DOCKER_TAGNAME}}
          echo IMAGE_ID=$IMAGE_ID
          echo VERSION=$VERSION
          echo GCR_PROJECT_ID=$GCR_PROJECT_ID
          # Share variables between steps (which each run in a separate process)
          echo "IMAGE_ID=$IMAGE_ID" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Build Team Service Image
        run: |-
          IMAGE_NAME=team_service
          echo "Building $IMAGE_NAME"
          cd ${{github.workspace}}/TeamService
          export CI_BUILD_DATETIME=$(date +"%Y-%m-%dT%H:%M:%S")
          export CI_BUILD_NUMBER=${{github.run_id}}
          export CI_COMMIT_REF=${{github.sha}}
          export CI_GITHUB_TAG=${{inputs.GITHUB_TAGNAME}}
          export CI_BRANCH_NAME=${{inputs.BRANCH_NAME}}
          export CI_DOCKER_TAG=${{inputs.DOCKER_TAGNAME}}
          echo $CI_BUILD_DATETIME
          echo $CI_BUILD_NUMBER
          echo $CI_COMMIT_REF
          echo $CI_GITHUB_TAG
          echo $CI_BRANCH_NAME
          echo $CI_DOCKER_TAG
          docker build --build-arg CI_BUILD_DATETIME=$CI_BUILD_DATETIME --build-arg CI_BUILD_NUMBER=$CI_BUILD_NUMBER --build-arg CI_COMMIT_REF=$CI_COMMIT_REF --build-arg CI_GITHUB_TAG=$CI_GITHUB_TAG --build-arg CI_BRANCH_NAME=$CI_BRANCH_NAME --build-arg CI_DOCKER_TAG=$CI_DOCKER_TAG -f ${{github.workspace}}/TeamService/dockerfile.prod -t ${{ env.IMAGE_ID }}:${{ env.VERSION }} .
          docker tag ${{ env.IMAGE_ID }}:${{ env.VERSION }} ${{ env.IMAGE_ID }}:latest
          docker push ${{ env.IMAGE_ID }}:${{ env.VERSION }}
          echo "- [${{env.IMAGE_ID}}:${{env.VERSION}}](https://${{env.IMAGE_ID}}:${{env.VERSION}})" >> ${{ github.workspace }}/Crediverse-${{inputs.BRANCH_NAME}}-CHANGELOG.md
          docker push ${{ env.IMAGE_ID }}:latest
      - name: Upload Changelog
        uses: actions/upload-artifact@v4
        with:
         name: changelog-${{ inputs.BRANCH_NAME }}-${{github.run_id}}
         path: ${{ github.workspace }}/Crediverse-${{ inputs.BRANCH_NAME }}-CHANGELOG.md
         overwrite: true
          
      - name: check outptut
        run: |-
          ls -ltrh ${{github.workspace}}
          cat ${{ github.workspace }}/Crediverse-${{inputs.BRANCH_NAME}}-CHANGELOG.md
  RUN_ROBOT_TESTS:
    needs:
      - build-crediverse
      #- set-env-variables
    uses: Concurrent-Systems/Crediverse/.github/workflows/robot-test-base.yml@main
    with:
      DOCKER_TAG: ${{inputs.DOCKER_TAGNAME}}
    secrets:
      db_pass: ${{ secrets.DB_PASS }}
  create-release-page:
    runs-on: ubuntu-latest
    permissions: 'write-all'
    needs:
      [
        check-repo-status,
        build-crediverse,
        build-crediverse-mobile,
        build-mas,
        build-teamService,
        RUN_ROBOT_TESTS,
      ]
    if: |
      inputs.BRANCH_NAME != 'main' &&  always()  && needs.check-repo-status.result == 'success' && needs.build-crediverse.result == 'success' && needs.RUN_ROBOT_TESTS.result == 'success' && needs.build-crediverse-mobile.result == 'success' && needs.build-mas.result == 'success'
    steps:
      - name: Get Current date
        id: date
        run: |-
          echo "NOW=$(date +%Y-%m-%d -d "yesterday")" >> $GITHUB_ENV
      - name: Download reports
        uses: actions/download-artifact@v4
        with:
          name: auto-regression-report
          path: ${{github.workspace}}/automated-tests/reports
      - name: Download Concurrent APK
        uses: actions/download-artifact@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          name: Concurrent APKs
          path: ${{github.workspace}}/CrediverseMobile/app/build/outputs/apk/
      - name: Download MovIvy APKs
        uses: actions/download-artifact@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          name: Moov Ivory Coast APKs
          path: ${{github.workspace}}/CrediverseMobile/app/build/outputs/apk/
      - name: Download MovTog APK
        uses: actions/download-artifact@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          name: Moov Togo APK
          path: ${{github.workspace}}/CrediverseMobile/app/build/outputs/apk/
      - name: check if report exist
        run: >-
          if [[ -d ${{github.workspace}}/automated-tests/reports ]]; 
          then 
            echo "dir exist"
          fi
      - name: zip file
        run: |
          cd ${{github.workspace}}/automated-tests/reports
          zip -r auto-regression-report.zip .
      - name: check files
        run: |
          ls -ltrh ${{github.workspace}}/automated-tests/reports
      - name: Download Changelog
        uses: actions/download-artifact@v4
        with:
            name: changelog-${{inputs.BRANCH_NAME}}-${{github.run_id}}  
      - name: check output
        run: | 
                ls -ltrh ${{github.workspace}}
                cat ${{ github.workspace }}/Crediverse-${{inputs.BRANCH_NAME}}-CHANGELOG.md          
      - name: Check if nightly-build tag exist
        uses: mukunku/tag-exists-action@v1.2.0
        id: checkTag
        with:
          tag: ${{ inputs.GITHUB_TAGNAME }}
      - run: echo ${{ steps.checkTag.outputs.exists }}
      - name: Delete git tag
        uses: actions/github-script@v3
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            try {
                await github.git.deleteRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: "tags/${{inputs.GITHUB_TAGNAME}}"
                })
            } catch (e) {
              console.log("The ${{inputs.GITHUB_TAGNAME}} tag doesn't exist yet: " + e)
              }
      - name: delete release by tag name
        uses: cb80/delrel@latest
        with:
          tag: ${{inputs.GITHUB_TAGNAME}}
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Auto Regression Report
        run: |
          echo "## Automatic Regression Report" >> ${{ github.workspace }}/Crediverse-${{inputs.BRANCH_NAME}}-CHANGELOG.md
          echo "- Please see assests report is attached" >> ${{ github.workspace }}/Crediverse-${{inputs.BRANCH_NAME}}-CHANGELOG.md
      - name: Mobile App
        run: |
          echo "## Mobile Application APK" >> ${{ github.workspace }}/Crediverse-${{inputs.BRANCH_NAME}}-CHANGELOG.md
          echo "- Please see assests APK is attached" >> ${{ github.workspace }}/Crediverse-${{inputs.BRANCH_NAME}}-CHANGELOG.md

      - name: Create Release
        id: create_release
        uses: ncipollo/release-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # This token is provided by Actions, you do not need to create your own token
        with:
          artifacts: '${{github.workspace}}/automated-tests/reports/auto-regression-report.zip,${{github.workspace}}/CrediverseMobile/app/build/outputs/apk/debug_demo_server/*.apk,${{github.workspace}}/CrediverseMobile/app/build/outputs/apk/movivy*/*.apk,${{github.workspace}}/CrediverseMobile/app/build/outputs/apk/movtog_demo_server/*.apk'
          tag: ${{inputs.GITHUB_TAGNAME}}
          commit: ${{inputs.BRANCH_NAME}}
          name: Crediverse-${{inputs.BRANCH_NAME}} Nightly Release ${{env.NOW}}
          draft: false
          replacesArtifacts: true
          removeArtifacts: false
          allowUpdates: true
          bodyFile: ${{ github.workspace }}/Crediverse-${{inputs.BRANCH_NAME}}-CHANGELOG.md
          discussionCategory: 'general'
      - name: Cleanup
        run: |
          rm -f ${{ github.workspace }}/Crediverse-${{inputs.BRANCH_NAME}}-CHANGELOG.md

  create-release-page-main:
    #runs-on: [self-hosted]
    runs-on: ubuntu-latest
    permissions: 'write-all'
    needs:
      [
        check-repo-status,
        build-crediverse,
        build-crediverse-mobile,
        build-mas,
        build-teamService,
        RUN_ROBOT_TESTS,
      ]
    if: |
      inputs.BRANCH_NAME == 'main' &&  always()  && needs.check-repo-status.result == 'success' && needs.build-crediverse.result == 'success' && needs.build-crediverse-mobile.result == 'success' && needs.RUN_ROBOT_TESTS.result == 'success' && needs.build-mas.result == 'success'

    steps:
      - name: Get Current date
        id: date
        run: |-
          echo "NOW=$(date +%Y-%m-%d -d "yesterday")" >> $GITHUB_ENV
      - name: Download reports
        uses: actions/download-artifact@v4
        with:
          name: auto-regression-report
          path: ${{github.workspace}}/automated-tests/reports
      - name: Download Concurrent APK
        uses: actions/download-artifact@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          name: Concurrent APKs
          path: ${{github.workspace}}/CrediverseMobile/app/build/outputs/apk/
      - name: Download MovIvy APKs
        uses: actions/download-artifact@v4
        env:
           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          name: Moov Ivory Coast APKs
          path: ${{github.workspace}}/CrediverseMobile/app/build/outputs/apk/
      - name: Download MovTog APK
        uses: actions/download-artifact@v4
        env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          name: Moov Togo APK
          path: ${{github.workspace}}/CrediverseMobile/app/build/outputs/apk/
      - name: check if report exist
        run: >-
          if [[ -d ${{github.workspace}}/automated-tests/reports ]]; 
          then 
            echo "dir exist"
          fi
      - name: zip file
        run: |
          cd ${{github.workspace}}/automated-tests/reports
          zip -r auto-regression-report.zip .
      - name: check files
        run: |
          ls -ltrh ${{github.workspace}}/automated-tests/reports
      - name: Download Changelog
        uses: actions/download-artifact@v4
        with:
            name: changelog-${{inputs.BRANCH_NAME}}-${{github.run_id}}  
      - name: check output
        run: | 
           ls -ltrh ${{github.workspace}}
           cat ${{ github.workspace }}/Crediverse-${{inputs.BRANCH_NAME}}-CHANGELOG.md

      - name: Check if nightly-build tag exist
        uses: mukunku/tag-exists-action@v1.2.0
        id: checkTag
        with:
          tag: ${{ inputs.GITHUB_TAGNAME }}
      - run: echo ${{ steps.checkTag.outputs.exists }}
      - name: Delete git tag
        uses: actions/github-script@v3
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            try {
                await github.git.deleteRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: "tags/${{inputs.GITHUB_TAGNAME}}"
                })
            } catch (e) {
              console.log("The ${{inputs.GITHUB_TAGNAME}} tag doesn't exist yet: " + e)
              }
      - name: Auto Regression Report
        run: |
          echo "## Automatic Regression Report" >> ${{ github.workspace }}/Crediverse-${{inputs.BRANCH_NAME}}-CHANGELOG.md
          echo "- Please see assests report is attached" >> ${{ github.workspace }}/Crediverse-${{inputs.BRANCH_NAME}}-CHANGELOG.md

      - name: Mobile App
        run: |
          echo "## Mobile Application APK" >> ${{ github.workspace }}/Crediverse-${{inputs.BRANCH_NAME}}-CHANGELOG.md
          echo "- Please see assests APK is attached" >> ${{ github.workspace }}/Crediverse-${{inputs.BRANCH_NAME}}-CHANGELOG.md

      - name: delete release by tag name
        uses: cb80/delrel@latest
        with:
          tag: ${{inputs.GITHUB_TAGNAME}}
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Create Release
        id: create_release
        uses: ncipollo/release-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # This token is provided by Actions, you do not need to create your own token
        with:
          artifacts: '${{github.workspace}}/automated-tests/reports/auto-regression-report.zip,${{github.workspace}}/CrediverseMobile/app/build/outputs/apk/debug_demo_server/*.apk,${{github.workspace}}/CrediverseMobile/app/build/outputs/apk/movivy*/*.apk,${{github.workspace}}/CrediverseMobile/app/build/outputs/apk/movtog_demo_server/*.apk'
          tag: ${{inputs.GITHUB_TAGNAME}}
          commit: ${{inputs.BRANCH_NAME}}
          name: Crediverse Nightly Release ${{env.NOW}}
          draft: false
          replacesArtifacts: true
          removeArtifacts: false
          allowUpdates: true
          bodyFile: ${{ github.workspace }}/Crediverse-${{inputs.BRANCH_NAME}}-CHANGELOG.md
          #discussionCategory: 'Announcements'
          #generateReleaseNotes: true
          prerelease: true
      - name: Cleanup
        run: |
          rm -f ${{ github.workspace }}/Crediverse-${{inputs.BRANCH_NAME}}-CHANGELOG.md

  trigger-crediverse-deployment-notification:
    runs-on: ubuntu-latest
    needs: create-release-page-main
    #if: ${{ success() }}
    steps:
      - name: Notify ITS GitOps Repository
        run: |
          curl -X POST \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Authorization: token ${{ secrets.GHRC_TOKEN }}" \
          -H "Content-Type: application/json" \
          https://api.github.com/repos/Concurrent-Systems/gitops/dispatches \
          -d '{
                "event_type": "trigger_crediverse_deployment",
                "client_payload": {
                  "crediverse_run_id": "${{inputs.DOCKER_TAGNAME}}",
                  "branch": "main"
                }
              }'
