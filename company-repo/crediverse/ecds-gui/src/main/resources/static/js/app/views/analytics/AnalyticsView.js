define( ['jquery', 'underscore', 'App', 'backbone', 'marionette', "handlebars", "chartjs", "momentjs", 'utils/CommonUtils',
	'models/AnalyticsModel', 'jquery.validate', 'jquery.select2' ],
    function($, _, App, BackBone, Marionette, Handlebars, ChartJS, moment, CommonUtils, AnalyticsModel, validator) {
        //ItemView provides some default rendering logic
        var AnalyticsView =  Marionette.ItemView.extend( {
        	tagName: 'div',
        	attributes: {
        		id: "analytics"
        	},
  		  	template: "AnalyticsView#analytics",
  		  	url: 'api/analytics',
  		  	
  		  	i18nAnalyticsTxt: App.i18ntxt.analytics,

  		  	model: new AnalyticsModel(),
			validator: null,
			dataDaysExpected: 7, // default is a weeks worth of days, but is reset when choosing either the "byWeek" or "byMonth" function
			
				// ----------	options: week|month that return number of days for the period
				// ----
				// ---- The purpose of this is to, check if the data returned has this many "days" of data...
				// ---- If the returned data from TS server does not have this many days of data...
				// ---- then the History Collection (found in the Analytics Configuration) was disabled and has not run yet while we are trying to view the graphs
				// ----
			selectionPeriod: {
				month: 30,		// yes, you can change how many days we "expect" to get from the server for this requested PERIOD ;)
				week: 7,
			},
			startDate: null,
			endDate: null,
			defaultLineType: "bar",
			blankCanvas: "<canvas id=\"graphCanvas\" width=\"400\" height=\"300\"></canvas>",
			dateArray: [
					// ----------
					// ---- As generated by getMonth() method later - used to translate number to date (0=Jan, 3=Mar, etc)
				"Jan", "Feb", "Mar", "Apr", "May", "Jun",
				"Jul", "Aug", "Sep", "Oct", "Nov", "Dec" 
			],
			graphColors: {
				blue: "#6495ed",
				green: "#228b22",
				red: "#ee1111",
				grey: "#b5b5b5",
				black: "#000000",
				lightBlue: "#add8e6",
				lightGreen: "#90ee90",
				darkBlue: "#1111ee",
				brown: "#931313",
				darkGrey: "#808080",
				cyan: "#00ffff",
				darkPurple: "#800080",
				pink: "#ffc0cb",
				yellow: "#ffd700",
				teal: "#008080",
				purple: "#ff00ff",
				orange: "#ffa500",
				consysOrange: "#f68b1f",
			},

  		  	breadcrumb: function() {
  		  		var txt = App.i18ntxt.analytics;
  		  		return {
  		  			heading: txt.heading,
  		  			defaultHome: false,
  		  			breadcrumb: [{
  		  				text: txt.headingBC,
						href:"#analytics",
						iclass: "fa fa-bar-chart",
  		  			}]
  		  		}
  		  	},
  		  	
            initialize: function (options) {
            	this.$("#canvasProgress").fadeIn();		// removeClass('hidden'); ?
            	this.$("#canvasContainer").fadeOut();	// addClass('hidden'); ?
            },

            onRender: function (ev) {
            	var self = this,
            		hasPerm = false;
            	
        			// Test permissions in context to block access if there are insufficient permissions
            	$.ajax({
        			
        			url: "api/context",
        			cache: false,
        			async: false,
        			type: "GET",
        			data: null, }) // end of request

        		.fail(function(json){
        		
        			App.log(txt.permissionLoadingError);
        			$("#badPermissions").removeClass('hidden'); }) // end of fail

        		.done(function(json){
        			
        			if ( json.user.roles[0].permissions )
        			{
        					// ----------
        					// ---- Iterate over permissions to find the group="Analytics" and name="View" permission
        				var i = 0;
                    	for (var perm in json.user.roles[0].permissions){
                    		perm = json.user.roles[0].permissions[i];
                    		if ( perm.group == "Analytics" && perm.name == "View" ) {
                        		hasPerm = true;
                    			App.log("Analytics_View Permission // Found -- Allowing");
                        		self.$("#correctPermissions").removeClass('hidden');
                        		if ( ! self.model.attributes.enableAnalytics ) {
                        			self.$("#analyticsDisabled").removeClass('hidden');
                        		}
                        		self.selectByWeek();
                    		}
                    		i += 1;
        		    	}
        			}
        			
        			if ( !hasPerm )
        			{
        				self.$("#badPermissions").removeClass('hidden');
        				App.log("Analytics_View Permission // Not Found -- Blocking");
        			}
        		}); // end of done AND end of ajax
            	
            },
            
            ui: {
            	uniqueAgents:		'#uniqueAgents',
            	
            	salesCount:			'#salesCount',
            	transfersCount:		'#transfersCount',
            	
            	salesValue:			'#salesValue',
            	transfersValue:		'#transfersValue',
            	replenishesValue:	'#replenishesValue',

//            	selectByYear:		'#selectByYear',
            	selectByMonth:		'#selectByMonth',
            	selectByWeek:		'#selectByWeek',
            	selectRefresh:		'#selectRefresh',
//            	selectToday:		'#selectToday', // in hours
            },

            events: {
            	"click @ui.uniqueAgents":		'uniqueAgents',
            	
            	"click @ui.salesCount":			'salesCount',
            	"click @ui.transfersCount":		'transfersCount',
            	
            	"click @ui.salesValue":			'salesValue',
            	"click @ui.transfersValue":		'transfersValue',
            	"click @ui.replenishesValue":	'replenishesValue',
            	
//            	"click @ui.selectByYear":		'selectByYear',
            	"click @ui.selectByMonth":		'selectByMonth',
            	"click @ui.selectByWeek":		'selectByWeek',
            	"click @ui.selectRefresh":		'selectRefresh',
//            	"click @ui.selectToday":		'selectToday',
            },

            selectByMonth: function(ev) {
            	
            		// ----------
            		// ---- this check is for multiple actions
            		// ---- ev must exist
            		// ---- must have the "Analytics View" Permissions (tested and set in the "onRender" function)
            		// ---- the button must not be "disabled" and must not be "active"
            		// ----
            	if ( ev && !this.validateButtonClick(ev) ) { return false; }
            	
            		// ----------
            		// ---- Preset startDate to 30 days (from 1 month ago)
            		// ---- Preset endDate to 1 day (to yesterday) -- the ajax call later will automatically add today (0 days ago) to the list of returned values
            		// ----
            	this.startDate	= this.longDateDaysAgo(29);
            	this.endDate	= this.longDateDaysAgo(1);
            	
            	this.dataDaysExpected	= this.selectionPeriod.month;
            	
            		// the "selectByMonth" requests the data for the SPECIFIC button that is active by it's ID (see associated function)
            	var buttonName = this.getActiveAnalyticButton();
            	
            	if ( buttonName ) {
            		this[buttonName]();
            	} else {
            		this.uniqueAgents();
            	}
            },
            
            selectByWeek: function(ev) {
            	
            		// ----------
            		// ---- see comments for above function, same principles
            	if ( ev && !this.validateButtonClick(ev) ) { return false; }
            	
            	this.startDate	= this.longDateDaysAgo(6);
            	this.endDate	= this.longDateDaysAgo(1);
            	
            	this.dataDaysExpected	= this.selectionPeriod.week;
            	
            	var buttonName = this.getActiveAnalyticButton();

            	if ( typeof(buttonName) != "undefined" ) {
            		this[buttonName]();
            	} else {
            		this.uniqueAgents();
            	}
            },

            selectRefresh: function(ev) {
            		// ----------
            		// ---- the "enableProgress" method ensures (or tries to ensure) that the "progress bar" is displayed while the ajax call is happening
            		// ---- the progress bar is automatically removed by the graph drawing method (this.graphBuild()) which is run at the end of any method performing "graph drawing"
            		// ----
            	if ( ev ) { this.enableProgress(ev); }
            	
            	var buttonName = this.getActivePeriodButton();

            	this[buttonName](ev);
            },

            uniqueAgents: function(ev) {
            	if ( ev && !this.validateButtonClick(ev) ) { return false; }

            	var self	= this;
            	var options	= {};
            	var url		= self.url;
            	var txt		= App.i18ntxt.analytics;
            	var btnId	= self.ui.uniqueAgents.selector;
            	
            	var lineType	= self.defaultLineType;
            	
            		// ----------
            		// ---- This (as with other relevant functions) retrieves the JSON content with the relevant data from the transaction server databases
            		// ---- DATABASES on TS server:
            		// ----		ap_analytics (for history data) (29 days history)
            		// ----		ap_transact (for live data) (only todays data)
            		// ----
            	url = url + "/uniqueAgentsCount?startDate=" + self.startDate + "&endDate=" + self.endDate;
            	
            	$.ajax({
            		url: url,
            		cache: false,
            		type: "GET",
            		data: null,
            		})
            		.fail(function(json){
            			App.log(txt.errorLoadingGraph);
            			App.log(JSON.stringify(json, null, 2));
            		})
            		.done(function(json){
        			
                    	var myData		= json.return;
                    	var data		= {};
        			
        				data = self.humanDates(myData);
            	
            			var graphData	= {
            	        	labels: data.labels,
            	        	datasets: [{
            	        	label: txt.graphTitle.uniqueAgentsCount,
            	        		data: data.values,
            	        		backgroundColor: self.graphColors.consysOrange,
                    	    	borderColor: self.graphColors.consysOrange,
                    	    	borderWidth: 1
            	        	}],
            	    	};
            			
            			var options		= {};
            	
            			self.graphBuild({ lineType:lineType, graphData:graphData, options:options, btnId:btnId });
      		  
            		});

            },
            
            salesCount: function(ev) {
            	if ( ev && !this.validateButtonClick(ev) ) { return false; }

            	var self	= this;
            	var options	= {};
            	var url		= self.url;
            	var txt		= App.i18ntxt.analytics;
            	var btnId	= self.ui.salesCount.selector;
            	
            	var lineType	= self.defaultLineType;
            	
            	url = url + "/salesCount?startDate=" + self.startDate + "&endDate=" + self.endDate;

            	var myDataFailed	= [],
            		myDataSuccess	= [],
            		myLabels		= [];

            	$.ajax({
            		url: url,
            		cache: false,
            		type: "GET",
            		data: null,
            		})
            		.fail(function(json){
            			App.log(txt.errorLoadingGraph);
            			App.log(JSON.stringify(json, null, 2));
            		})
            		.done(function(json){

                    	var myData		= json.return;
                    	var data		= {};
        			
        				data = self.humanDates(myData);

            			var graphData	= {
            					labels: data.labels,
            					datasets: [{
            						label: 'Number of Sales',
            						data: data.values,
            						backgroundColor: self.graphColors.consysOrange,
            						borderColor: self.graphColors.consysOrange,
            						borderWidth: 1
            					}],
            			};
            			var options		= {};
            	
            			self.graphBuild({ lineType:lineType, graphData:graphData, options:options, btnId:btnId });
            	});
            },
            
            transfersCount: function(ev) {
               	if ( ev && !this.validateButtonClick(ev) ) { return false; }

            	var self	= this;
            	var options	= {};
            	var url		= self.url;
            	var txt		= App.i18ntxt.analytics;
            	var btnId	= self.ui.transfersCount.selector;
            	
            	var lineType	= self.defaultLineType;
            	
            	url = url + "/transfersCount?startDate=" + self.startDate + "&endDate=" + self.endDate;

            	$.ajax({
            		url: url,
            		cache: false,
            		type: "GET",
            		data: null,
            		})
            		.fail(function(json){
            			App.log(txt.errorLoadingGraph);
            			App.log(JSON.stringify(json, null, 2));
            		})
            		.done(function(json){

                    	var myData		= json.return;
                    	var data		= {};
        			
        				data = self.humanDates(myData);

            			var graphData	= {
            					labels: data.labels,
            					datasets: [{
            						label: 'Number of Successful Transfers',
            						data: data.values,
            						backgroundColor: self.graphColors.consysOrange,
            						borderColor: self.graphColors.consysOrange,
            						borderWidth: 1
            					}],
            			};
            			var options		= {};
            	
            			self.graphBuild({ lineType:lineType, graphData:graphData, options:options, btnId:btnId });
            	});
            },

            salesValue: function(ev) {
            	if ( ev && !this.validateButtonClick(ev) ) { return false; }

            	var self	= this;
            	var options	= {};
            	var url		= self.url;
            	var txt		= App.i18ntxt.analytics;
            	var btnId	= self.ui.salesValue.selector;
            	
            	var lineType	= self.defaultLineType;
            	
            	url = url + "/salesValue?startDate=" + self.startDate + "&endDate=" + self.endDate;
            	
            	$.ajax({
            		url: url,
            		cache: false,
            		type: "GET",
            		data: null,
            		})
            		.fail(function(json){
            			App.log(txt.errorLoadingGraph);
            			App.log(JSON.stringify(json, null, 2));
            		})
            		.done(function(json){

                    	var myData		= json.return;
                    	var data		= {};
        			
        				data = self.humanDates(myData);
            			
            			var graphData	= {
            	        	labels: data.labels,
            	        	datasets: [{
            	            	label: 'Value of Retail Sales',
            	            	data: data.values,
            	            	backgroundColor: self.graphColors.consysOrange,
            	            	borderColor: self.graphColors.consysOrange,
            	            	borderWidth: 1
            	        	}]
            	    	};
            	
            			self.graphBuild({ lineType:lineType, graphData:graphData, options:options, btnId:btnId });

                	});

            },
            
            transfersValue: function(ev) {
            	if ( ev && !this.validateButtonClick(ev) ) { return false; }

            	var self	= this;
            	var options	= {};
            	var url		= self.url;
            	var txt		= App.i18ntxt.analytics;
            	var btnId	= self.ui.transfersValue.selector;
            	
            	var lineType	= self.defaultLineType;
            	
            	url = url + "/transfersValue?startDate=" + self.startDate + "&endDate=" + self.endDate;
            	
            	$.ajax({
            		url: url,
            		cache: false,
            		type: "GET",
            		data: null,
            		})
            		.fail(function(json){
            			App.log(txt.errorLoadingGraph);
            			App.log(JSON.stringify(json, null, 2));
            		})
            		.done(function(json){

                    	var myData		= json.return;
                    	var data		= {};
        			
        				data = self.humanDates(myData);
            			
            			var graphData	= {
            	        	labels: data.labels,
            	        	datasets: [{
            	            	label: 'Value of Transfers',
            	            	data: data.values,
            	            	backgroundColor: self.graphColors.consysOrange,
            	            	borderColor: self.graphColors.consysOrange,
            	            	borderWidth: 1
            	        	}]
            	    	};
            	
            			self.graphBuild({ lineType:lineType, graphData:graphData, options:options, btnId:btnId });

                	});
            },
            
            replenishesValue: function(ev) {
            	if ( ev && !this.validateButtonClick(ev) ) { return false; }

            	var self	= this;
            	var options	= {};
            	var url		= self.url;
            	var txt		= App.i18ntxt.analytics;
            	var btnId	= self.ui.replenishesValue.selector;
            	
            	var lineType	= self.defaultLineType;
            	
            	url = url + "/replenishesValue?startDate=" + self.startDate + "&endDate=" + self.endDate;

            	$.ajax({
            		url: url,
            		cache: false,
            		type: "GET",
            		data: null,
            		})
            		.fail(function(json){
            			App.log(txt.errorLoadingGraph);
            			App.log(JSON.stringify(json, null, 2));
            		})
            		.done(function(json){

                    	var myData		= json.return;
                    	var data		= {};
        			
        				data = self.humanDates(myData);
        				
            			var graphData	= {
            	        	labels: data.labels,
            	        	datasets: [{
            	            	label: 'Value of Replenishes',
            	            	data: data.values,
            	            	backgroundColor: self.graphColors.consysOrange,
            	            	borderColor: self.graphColors.consysOrange,
            	            	borderWidth: 1
            	        	}]
            	    	};
            	
            			self.graphBuild({ lineType:lineType, graphData:graphData, options:options, btnId:btnId });

                	});
            },
            
            graphBuild: function(ev) {
            	var txt = App.i18ntxt.analytics;
            	
            	var graphDefaultOptions		= {
            			animateScale: true,
            			animation: {
            				duration: 1800,
            			},
            			responsive: true,
                        showTooltips: true,
                        multiTooltipTemplate: '<%= value %>',
            	    	tooltips: {
                            enabled: true,
                            mode: 'index',
                            intersect: true,
                            xPadding: 15,
                            yPadding: 15,
                            titleMarginBottom: 12,
                            backgroundColor: 'rgba(0,0,0,0.7)',
                            bodySpacing: 10,
                            //position: 'nearest',
                            callbacks: {
                                label: function(tooltipItems, data) {
                                	//App.log(JSON.stringify(tooltipItems));
                                	return tooltipItems.yLabel.toLocaleString();
                                }
                            },
                        },
                        legend: {
                            display: true,
                            labels: {
                            	fontSize: 16,
                            },
                        },
                        scales: {
        	    			xAxes: [{
        	    				stacked: true,
        	    		        ticks: {
        	    		        	autoSkip: false,
        	    		        	fontSize: 13,
        	    		        },
        	    			}],
                            yAxes: [{
                            	stacked: true,
                                ticks: {
                                	fontSize: 16,
                                    beginAtZero:true,
                                    callback: function(value, index, values) {
                	                	return value.toLocaleString();
                	                }
                                }
                            }],
                        }
            	    };

            	if ( ev.options.tooltips && ev.options.tooltips.callbacks && ev.options.tooltips.callbacks.label ) {
            		graphDefaultOptions.tooltips.callbacks = ev.options.tooltips.callbacks; 
            	}
            	if ( ev.options.scales && ev.options.scales.yAxes[0] && ev.options.scales.yAxes[0].ticks && ev.options.scales.yAxes[0].ticks.callback ) {
            		graphDefaultOptions.scales.yAxes[0].ticks.callback = ev.options.scales.yAxes[0].ticks.callback; 
            	}
            	
        		// ----------
        		// ---- FIXME
				// ----			REASON: If the canvas element is not "replaced", the next graph is drawn "OVER" the previous one (and can then be seen with 'mouseover' action)
            	// ----
        		// ----			The previous graph remains in the canvas even if cleared (using canvas .clear() methods and other things I've tried)
        		// ----			This "re-creation" of the canvas element is a workaround (albeit, not a _very_ bad one).
        		// ----			It gives us a "BLANK" canvas for the next graph.
            	// ----
            	this.$("#graphContainer").html(this.blankCanvas);
            	
            	var ctx = this.$("#graphCanvas");
            	
            	var myChart = new Chart(ctx, {
            	    type: ev.lineType,
            	    data: ev.graphData,
            	    options: graphDefaultOptions,
            	});
            	
            	this.$("#canvasContainer").fadeIn(); // removeClass('hidden');
            	this.$("#canvasProgress").fadeOut(); // addClass('hidden');

            	$( '#' + $( ev.btnId ).attr('data-btn-parent') ).find('.btn').removeClass('disabled').removeClass('active');
            	$( ev.btnId ).addClass('disabled').addClass('active');
            },
            
            buttonIsEnabled: function(ev) {
            	var result = true;
            		// ---- Only run if we are NOT a "disabled" button 
            	if ( this.$( '#' + ev.currentTarget.id ).hasClass('disabled') )
            	{
            		result = false;
            	}
            	return result;
            },
            
            buttonIsActive: function(ev) {
            	var result = true;
            		// ---- Only run if we are NOT a "disabled" button 
            	if ( ! this.$( '#' + ev.currentTarget.id ).hasClass('active') )
            	{
            		result = false;
            	}
            	return result;
            },
            
            enableProgress: function(ev) {        	
            		// ---------- 
            		// ---- Make the progress bar visible during data collection
        			// ---- AND make the canvas hidden during data collection 
        			// ---- 
            	this.$("#canvasProgress").fadeIn(); //removeClass('hidden');
            	this.$("#canvasContainer").fadeOut(); //('hidden');
            	
            	return true;
            },
            
            validateButtonClick: function(ev) {
            	
        		// ----------
        		// ---- this check is for multiple actions
        		// ---- the button must not be "disabled" and must not be "active"
            	// ---- NOTE: enableProgress is called when we confirm the above
            	// ---- once confirmed... we remove all sibling button "active" states, and enable ours only
        		// ----

            	var result = false;
            	
            	if ( this.buttonIsEnabled(ev) && ! this.buttonIsActive(ev) && this.enableProgress(ev) )
            	{
            		if ( $( '#' + ev.currentTarget.id ).attr('data-btn-parent') )
            		{
            			this.$( "#" + $( '#' + ev.currentTarget.id ).attr('data-btn-parent') ).find('.btn').removeClass('active');
            			this.$( '#' + ev.currentTarget.id ).addClass('active');
            		}
            		
            		result = true;
            	}
            	return result;
            },
            
            getActiveAnalyticButton: function() {
            	return this.$( '#analyticsButtons' ).find('.btn.active').attr('id');
            },
            
            getActivePeriodButton: function() {
            	return this.$( '#periodButtons' ).find('.btn.active').attr('id');
            },
            
            humanDates: function(myData) {

            	var data = {
            			labels: [],
            			values: []
            		};

            	var i = 0;
            	
            	for (var key in myData){
		    		myDate		= new Date( key );
		    		
		        		// use "Jan", "Feb", etc as readable dates with the "1", "2", etc day of month
		        	data.labels[i]	= this.dateArray[myDate.getMonth()] + " " + myDate.getDate();
		        	data.values[i]	= myData[key];
		        	i+=1;
		    	}
            	
            	if ( i < this.dataDaysExpected )
            	{
            		App.log("Found less days returned than the number of days expected...");
            		App.log("Days returned: " + i + "; Days expected: " + this.dataDaysExpected );
            		if ( this.$("#analyticsDisabled").hasClass('hidden') ) {
            			this.$("#analyticsRecentlyDisabled").removeClass("hidden");
            		}
            	}
            	
            	return data;
            },
            
            longDateDaysAgo: function(days) {
            	var myDate		= new Date();
            	var year, mon, day;
            	
            	myDate.setTime( myDate.getTime() - ( 60 * 60 * 24 * days * 1000) );
            	
            	year	= myDate.getFullYear();
            	mon		= ((myDate.getMonth() + 1) < 10) ? ("0"+(myDate.getMonth()+1)) : (myDate.getMonth()+1); 
        		day		= ((myDate.getDate()) < 10) ? ("0"+(myDate.getDate())) : (myDate.getDate());

        		
        			// Conversion above gets the date for the "specified number of days ago" and returns it in string format YYYY-MM-DD 
            	return year + "-" + mon + "-" + day;
            },
        });
        
        return AnalyticsView;
    });

